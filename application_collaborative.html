<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Handicap - Mode Collaboratif</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* √âcran de connexion */
        .login-screen {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .login-screen h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .role-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-btn {
            flex: 1;
            padding: 30px 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .role-btn:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .role-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .role-btn .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .role-btn .title {
            font-weight: bold;
            font-size: 1.2em;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        /* Interface principale */
        .main-interface {
            display: none;
        }

        .main-interface.active {
            display: block;
        }

        .session-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .session-code {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 3px;
        }

        .participant-count {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            background: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .diagram-container {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .diagram-container.active {
            display: block;
        }

        .question-title {
            text-align: center;
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .canvas-wrapper {
            position: relative;
            max-width: 1100px;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            cursor: crosshair;
            min-height: 600px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #2c3e50;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            color: #555;
        }

        .qr-code-container {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .hidden {
            display: none;
        }

        .animator-controls {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }

            .tab {
                padding: 10px 20px;
                font-size: 14px;
            }

            .question-title {
                font-size: 1.2em;
            }

            .session-code {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Formation Sensibilisation au Handicap</h1>

        <!-- √âcran de connexion -->
        <div id="loginScreen" class="login-screen">
            <h2>Rejoindre une session</h2>
            
            <div class="role-selection">
                <div class="role-btn" onclick="selectRole('animator')">
                    <div class="icon">üë®‚Äçüè´</div>
                    <div class="title">Animateur</div>
                </div>
                <div class="role-btn selected" onclick="selectRole('participant')">
                    <div class="icon">üë§</div>
                    <div class="title">Participant</div>
                </div>
            </div>

            <div id="animatorForm" class="hidden">
                <div class="input-group">
                    <label>Cr√©er une nouvelle session</label>
                    <input type="text" id="sessionNameInput" placeholder="Nom de la session (optionnel)">
                </div>
                <button class="btn btn-primary" onclick="createSession()">üöÄ Cr√©er la session</button>
            </div>

            <div id="participantForm">
                <div class="input-group">
                    <label>Code de session</label>
                    <input type="text" id="sessionCodeInput" placeholder="Ex: ABC123" style="text-transform: uppercase;">
                </div>
                <div class="input-group">
                    <label>Votre pseudo (optionnel)</label>
                    <input type="text" id="pseudoInput" placeholder="Ex: Jean">
                </div>
                <button class="btn btn-primary" onclick="joinSession()">‚úÖ Rejoindre</button>
            </div>
        </div>

        <!-- Interface principale -->
        <div id="mainInterface" class="main-interface">
            <div class="session-info">
                <div>
                    <strong>Code de session :</strong>
                    <span class="session-code" id="displaySessionCode"></span>
                </div>
                <div class="participant-count">
                    <span>üë•</span>
                    <span id="participantCount">0</span>
                    <span>participant(s)</span>
                </div>
                <button class="btn btn-danger" onclick="leaveSession()">üö™ Quitter</button>
            </div>

            <div id="animatorPanel" class="animator-controls hidden">
                <h3 style="margin-bottom: 15px;">üéõÔ∏è Contr√¥les Animateur</h3>
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearAllPoints()">üóëÔ∏è Effacer tous les points</button>
                    <button class="btn btn-success" onclick="downloadResults()">üíæ T√©l√©charger les r√©sultats</button>
                </div>
                <div id="qrCodeArea" class="qr-code-container">
                    <h4>QR Code pour rejoindre la session</h4>
                    <div id="qrcode"></div>
                    <p style="margin-top: 10px;">Les participants peuvent scanner ce QR code</p>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showDiagram('diagram1')">Difficult√©s au travail</button>
                <button class="tab" onclick="showDiagram('diagram2')">Envie de rester</button>
                <button class="tab" onclick="showDiagram('diagram3')">Stress au travail</button>
            </div>

            <!-- Diagramme 1 -->
            <div id="diagram1" class="diagram-container active">
                <h2 class="question-title">Ce qui est le plus difficile √† g√©rer dans mon quotidien au travail</h2>
                <div class="canvas-wrapper">
                    <canvas id="canvas1"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearMyPoints('canvas1')">üóëÔ∏è Effacer mon point</button>
                </div>
                <div class="color-picker">
                    <span style="font-weight: bold;">Couleur de votre point :</span>
                    <div class="color-option selected" style="background: #e74c3c;" onclick="selectColor('canvas1', '#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="selectColor('canvas1', '#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="selectColor('canvas1', '#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="selectColor('canvas1', '#f39c12')"></div>
                    <div class="color-option" style="background: #9b59b6;" onclick="selectColor('canvas1', '#9b59b6')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="selectColor('canvas1', '#1abc9c')"></div>
                </div>
                <div class="instructions">
                    üí° <strong>Instructions :</strong> Cliquez sur le diagramme pour placer votre point. Vous ne pouvez placer qu'un seul point (cliquer √† nouveau d√©place votre point). Tous les participants voient les points en temps r√©el !
                </div>
            </div>

            <!-- Diagramme 2 -->
            <div id="diagram2" class="diagram-container">
                <h2 class="question-title">Ce qui me donne envie de rester dans une entreprise</h2>
                <div class="canvas-wrapper">
                    <canvas id="canvas2"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearMyPoints('canvas2')">üóëÔ∏è Effacer mon point</button>
                </div>
                <div class="color-picker">
                    <span style="font-weight: bold;">Couleur de votre point :</span>
                    <div class="color-option selected" style="background: #e74c3c;" onclick="selectColor('canvas2', '#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="selectColor('canvas2', '#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="selectColor('canvas2', '#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="selectColor('canvas2', '#f39c12')"></div>
                    <div class="color-option" style="background: #9b59b6;" onclick="selectColor('canvas2', '#9b59b6')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="selectColor('canvas2', '#1abc9c')"></div>
                </div>
                <div class="instructions">
                    üí° <strong>Instructions :</strong> Cliquez sur le diagramme pour placer votre point. Vous ne pouvez placer qu'un seul point (cliquer √† nouveau d√©place votre point). Tous les participants voient les points en temps r√©el !
                </div>
            </div>

            <!-- Diagramme 3 -->
            <div id="diagram3" class="diagram-container">
                <h2 class="question-title">Ce qui me stresse au travail</h2>
                <div class="canvas-wrapper">
                    <canvas id="canvas3"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearMyPoints('canvas3')">üóëÔ∏è Effacer mon point</button>
                </div>
                <div class="color-picker">
                    <span style="font-weight: bold;">Couleur de votre point :</span>
                    <div class="color-option selected" style="background: #e74c3c;" onclick="selectColor('canvas3', '#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db;" onclick="selectColor('canvas3', '#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71;" onclick="selectColor('canvas3', '#2ecc71')"></div>
                    <div class="color-option" style="background: #f39c12;" onclick="selectColor('canvas3', '#f39c12')"></div>
                    <div class="color-option" style="background: #9b59b6;" onclick="selectColor('canvas3', '#9b59b6')"></div>
                    <div class="color-option" style="background: #1abc9c;" onclick="selectColor('canvas3', '#1abc9c')"></div>
                </div>
                <div class="instructions">
                    üí° <strong>Instructions :</strong> Cliquez sur le diagramme pour placer votre point. Vous ne pouvez placer qu'un seul point (cliquer √† nouveau d√©place votre point). Tous les participants voient les points en temps r√©el !
                </div>
            </div>
        </div>
    </div>

    <!-- QRCode.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Configuration globale
        let currentSession = null;
        let currentUser = null;
        let isAnimator = false;
        let sessionData = {};

        // Configuration pour chaque canvas
        const canvasConfig = {
            canvas1: {
                image: null,
                color: '#e74c3c'
            },
            canvas2: {
                image: null,
                color: '#e74c3c'
            },
            canvas3: {
                image: null,
                color: '#e74c3c'
            }
        };

        // Chemins des images
        const imageSources = {
            canvas1: './diagramme_difficultes.png',
            canvas2: './diagramme_rester_entreprise.png',
            canvas3: './diagramme_stress.png'
        };

        // Initialiser tous les canvas
        Object.keys(canvasConfig).forEach(canvasId => {
            initCanvas(canvasId);
        });

        function initCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                canvasConfig[canvasId].image = img;
                redrawCanvas(canvasId);
            };
            
            img.onerror = function() {
                console.error('Erreur de chargement de l\'image:', imageSources[canvasId]);
                // Essayer sans le ./
                if (img.src.includes('./')) {
                    img.src = imageSources[canvasId].replace('./', '');
                }
            };
            
            img.src = imageSources[canvasId];

            // Gestionnaire de clic
            canvas.addEventListener('click', function(e) {
                if (!currentSession) return;
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                
                addPoint(canvasId, x, y);
            });
        }

        function selectRole(role) {
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.role-btn').classList.add('selected');
            
            if (role === 'animator') {
                document.getElementById('animatorForm').classList.remove('hidden');
                document.getElementById('participantForm').classList.add('hidden');
            } else {
                document.getElementById('animatorForm').classList.add('hidden');
                document.getElementById('participantForm').classList.remove('hidden');
            }
        }

        function generateSessionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createSession() {
            const sessionCode = generateSessionCode();
            const sessionName = document.getElementById('sessionNameInput').value || 'Session sans nom';
            
            currentSession = sessionCode;
            currentUser = 'animator_' + Date.now();
            isAnimator = true;
            
            // Initialiser les donn√©es de session
            sessionData = {
                code: sessionCode,
                name: sessionName,
                created: Date.now(),
                participants: {},
                points: {
                    canvas1: [],
                    canvas2: [],
                    canvas3: []
                }
            };
            
            // Sauvegarder dans localStorage (simulation)
            saveSessionData();
            
            showMainInterface();
            generateQRCode();
        }

        function joinSession() {
            const code = document.getElementById('sessionCodeInput').value.toUpperCase().trim();
            const pseudo = document.getElementById('pseudoInput').value || 'Participant';
            
            if (!code) {
                alert('‚ö†Ô∏è Veuillez entrer un code de session');
                return;
            }
            
            // Charger la session depuis localStorage
            const storedSession = localStorage.getItem('session_' + code);
            if (!storedSession) {
                alert('‚ùå Session introuvable. V√©rifiez le code.');
                return;
            }
            
            currentSession = code;
            currentUser = 'user_' + Date.now();
            isAnimator = false;
            
            sessionData = JSON.parse(storedSession);
            
            // Ajouter le participant
            sessionData.participants[currentUser] = {
                pseudo: pseudo,
                joined: Date.now()
            };
            
            saveSessionData();
            showMainInterface();
            startAutoRefresh();
        }

        function showMainInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').classList.add('active');
            document.getElementById('displaySessionCode').textContent = currentSession;
            
            if (isAnimator) {
                document.getElementById('animatorPanel').classList.remove('hidden');
            }
            
            updateParticipantCount();
            loadAllPoints();
        }

        function leaveSession() {
            if (confirm('Voulez-vous vraiment quitter la session ?')) {
                if (isAnimator && confirm('‚ö†Ô∏è En tant qu\'animateur, quitter supprimera la session pour tous. Continuer ?')) {
                    localStorage.removeItem('session_' + currentSession);
                } else if (!isAnimator) {
                    delete sessionData.participants[currentUser];
                    saveSessionData();
                }
                
                location.reload();
            }
        }

        function addPoint(canvasId, x, y) {
            // Supprimer les points existants de cet utilisateur sur ce canvas
            sessionData.points[canvasId] = sessionData.points[canvasId].filter(
                point => point.userId !== currentUser
            );
            
            // Ajouter le nouveau point
            const point = {
                x: x,
                y: y,
                color: canvasConfig[canvasId].color,
                userId: currentUser,
                timestamp: Date.now()
            };
            
            sessionData.points[canvasId].push(point);
            saveSessionData();
            redrawCanvas(canvasId);
        }

        function clearMyPoints(canvasId) {
            sessionData.points[canvasId] = sessionData.points[canvasId].filter(
                point => point.userId !== currentUser
            );
            saveSessionData();
            redrawCanvas(canvasId);
        }

        function clearAllPoints() {
            if (!isAnimator) return;
            
            if (confirm('Effacer tous les points de tous les participants ?')) {
                sessionData.points = {
                    canvas1: [],
                    canvas2: [],
                    canvas3: []
                };
                saveSessionData();
                Object.keys(canvasConfig).forEach(canvasId => redrawCanvas(canvasId));
            }
        }

        function redrawCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const config = canvasConfig[canvasId];
            
            // Effacer et redessiner l'image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (config.image) {
                ctx.drawImage(config.image, 0, 0);
            }

            // Dessiner tous les points de la session
            if (sessionData.points && sessionData.points[canvasId]) {
                sessionData.points[canvasId].forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = point.color;
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
            }
        }

        function loadAllPoints() {
            Object.keys(canvasConfig).forEach(canvasId => {
                redrawCanvas(canvasId);
            });
        }

        function selectColor(canvasId, color) {
            canvasConfig[canvasId].color = color;
            
            const container = document.getElementById(canvasId).closest('.diagram-container');
            container.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function showDiagram(diagramId) {
            document.querySelectorAll('.diagram-container').forEach(container => {
                container.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(diagramId).classList.add('active');
            event.target.classList.add('active');
        }

        function saveSessionData() {
            localStorage.setItem('session_' + currentSession, JSON.stringify(sessionData));
        }

        function loadSessionData() {
            const stored = localStorage.getItem('session_' + currentSession);
            if (stored) {
                sessionData = JSON.parse(stored);
                loadAllPoints();
                updateParticipantCount();
            }
        }

        function updateParticipantCount() {
            const count = Object.keys(sessionData.participants || {}).length;
            document.getElementById('participantCount').textContent = count;
        }

        function startAutoRefresh() {
            setInterval(() => {
                loadSessionData();
            }, 2000); // Rafra√Æchir toutes les 2 secondes
        }

        function generateQRCode() {
            const url = window.location.href.split('?')[0] + '?session=' + currentSession;
            
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            new QRCode(qrcodeContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function downloadResults() {
            if (!isAnimator) return;
            
            let results = `R√©sultats de la session: ${sessionData.name}\n`;
            results += `Code: ${currentSession}\n`;
            results += `Date: ${new Date(sessionData.created).toLocaleString('fr-FR')}\n`;
            results += `Participants: ${Object.keys(sessionData.participants).length}\n\n`;
            
            ['canvas1', 'canvas2', 'canvas3'].forEach((canvasId, index) => {
                const questions = [
                    'Difficult√©s au travail',
                    'Envie de rester dans l\'entreprise',
                    'Stress au travail'
                ];
                
                results += `\n=== ${questions[index]} ===\n`;
                results += `Nombre de points: ${sessionData.points[canvasId].length}\n`;
                
                sessionData.points[canvasId].forEach((point, i) => {
                    const participant = sessionData.participants[point.userId];
                    const pseudo = participant ? participant.pseudo : 'Anonyme';
                    results += `Point ${i+1}: ${pseudo} - Position (${Math.round(point.x)}, ${Math.round(point.y)}) - Couleur: ${point.color}\n`;
                });
            });
            
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resultats_session_${currentSession}.txt`;
            a.click();
        }

        // D√©tecter si on arrive via QR code
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');
            
            if (sessionParam) {
                document.getElementById('sessionCodeInput').value = sessionParam;
            }
        });
    </script>
</body>
</html>
